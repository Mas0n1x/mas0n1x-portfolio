server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Proxy API requests to Node.js server on host
    location /api {
        proxy_pass http://172.17.0.1:3000/api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_pass_header Set-Cookie;
    }

    # Admin panel - always accessible
    location /admin {
        try_files $uri $uri/ /admin/index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Kunde panel - always accessible
    location /kunde {
        try_files $uri $uri/ /kunde/index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Maintenance page - no redirect loop
    location = /maintenance.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Named location for maintenance redirect
    location @maintenance {
        return 302 $scheme://$http_host/maintenance.html;
    }

    # Internal endpoint for maintenance check
    location = /internal/maintenance-check {
        internal;
        proxy_pass http://172.17.0.1:3000/api/maintenance-check;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
    }

    # Check maintenance mode via subrequest for main pages
    location = / {
        auth_request /internal/maintenance-check;
        error_page 403 = @maintenance;
        try_files $uri /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    location = /index.html {
        auth_request /internal/maintenance-check;
        error_page 403 = @maintenance;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    location = /projekt-starten.html {
        auth_request /internal/maintenance-check;
        error_page 403 = @maintenance;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Cache static assets (excluding html)
    location ~* \.(jpg|jpeg|png|gif|ico|css|woff|woff2)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # JS files - short cache
    location ~* \.js$ {
        expires 1h;
        add_header Cache-Control "public";
    }
}
